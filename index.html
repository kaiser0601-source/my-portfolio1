<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å…¨çƒè³‡ç”¢é…ç½®å„€è¡¨æ¿</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-50 min-h-screen font-sans text-slate-900">

    <div id="login-section" class="fixed inset-0 bg-slate-900 flex items-center justify-center z-50">
        <div class="bg-white p-10 rounded-2xl shadow-2xl w-full max-w-md">
            <h2 class="text-3xl font-black text-center mb-6">ç¾è‚¡éƒ¨ä½è¨ˆç®—</h2>
            <input type="password" id="password-input" placeholder="è«‹è¼¸å…¥è¨ªå•å¯†ç¢¼" class="w-full p-3 border-2 rounded-xl mb-4 text-center">
            <button onclick="checkPassword()" class="w-full bg-blue-600 text-white py-3 rounded-xl font-bold hover:bg-blue-700">è§£é–é€²å…¥</button>
            <p id="login-error" class="text-red-500 text-sm mt-4 text-center hidden">å¯†ç¢¼éŒ¯èª¤</p>
        </div>
    </div>

    <div id="main-content" class="hidden container mx-auto p-4 max-w-5xl">
        <header class="flex justify-between items-center my-8 bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
            <div>
                <h1 class="text-2xl font-black">Portfolio Dashboard</h1>
                <p id="fx-rate-display" class="text-sm text-blue-500 font-bold">åŒ¯ç‡è¼‰å…¥ä¸­...</p>
            </div>
            <div class="flex gap-3">
                <select id="display-currency" onchange="renderAssets()" class="p-2 border rounded-lg font-bold bg-slate-50">
                    <option value="TWD">é¡¯ç¤º TWD</option>
                    <option value="USD">é¡¯ç¤º USD</option>
                </select>
                <button onclick="fetchAllData()" class="bg-indigo-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-indigo-700">ğŸ”„ åˆ·æ–°å ±åƒ¹</button>
            </div>
        </header>

        <details class="mb-6 bg-white rounded-xl shadow-sm border border-slate-200">
            <summary class="p-4 cursor-pointer font-bold text-slate-600">æ•¸æ“šæºè¨­å®š (API Key / Google Sheet)</summary>
            <div class="p-4 space-y-4">
                <input type="text" id="sheet-url" class="w-full p-2 border rounded" placeholder="Google Sheet CSV é€£çµ (å°è‚¡èˆ‡åŒ¯ç‡)">
                <input type="text" id="finnhub-key" class="w-full p-2 border rounded" placeholder="Finnhub API Key (ç¾è‚¡)">
                <button onclick="saveConfig()" class="bg-slate-800 text-white px-4 py-2 rounded">å„²å­˜è¨­å®š</button>
            </div>
        </details>

        <div class="grid grid-cols-1 md:grid-cols-4 gap-3 mb-8 bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
            <input type="text" id="asset-name" placeholder="ä»£è™Ÿ (å¦‚: 2330 æˆ– TSLA)" class="p-3 border rounded-xl uppercase">
            <input type="number" id="asset-amount" placeholder="æŒæœ‰è‚¡æ•¸" class="p-3 border rounded-xl">
            <select id="asset-type" class="p-3 border rounded-xl bg-white">
                <option value="TWD">å°è‚¡ (TWD)</option>
                <option value="USD">ç¾è‚¡ (USD)</option>
            </select>
            <button onclick="addAsset()" class="bg-black text-white p-3 rounded-xl font-bold hover:opacity-80">+ æ–°å¢/ç´¯åŠ </button>
        </div>

        <div class="bg-white rounded-2xl shadow-xl border border-slate-200 overflow-hidden mb-6">
            <table class="w-full text-left">
                <thead class="bg-slate-50 border-b">
                    <tr>
                        <th class="p-4 text-sm font-bold">æ¨™çš„</th>
                        <th class="p-4 text-sm font-bold">è‚¡æ•¸</th>
                        <th class="p-4 text-sm font-bold">ç¾åƒ¹</th>
                        <th class="p-4 text-sm font-bold text-right">ä¼°å€¼</th>
                        <th class="p-4 text-sm font-bold text-center">æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="asset-list" class="divide-y"></tbody>
            </table>
            <div class="p-6 bg-slate-900 text-white flex justify-between items-center">
                <span class="text-slate-400">è³‡ç”¢ç¸½æ·¨å€¼</span>
                <span id="total-val" class="text-3xl font-black text-yellow-400">$ 0</span>
            </div>
        </div>
    </div>

    <script>
        const PAGE_PASSWORD = "9003042449"; // ä¿®æ”¹ä½ çš„é–‹å•Ÿå¯†ç¢¼
        let assets = JSON.parse(localStorage.getItem('global_assets')) || [];
        let config = JSON.parse(localStorage.getItem('global_config')) || { 
    sheet: 'ä½ çš„Googleè©¦ç®—è¡¨CSVé€£çµ', 
    finnhub: 'd5ut0d1r01qr4f8acirgd5ut0d1r01qr4f8acis0' };
        let fxRate = 32.0; 

        // 1. å¯†ç¢¼é©—è­‰
        function checkPassword() {
            if (document.getElementById('password-input').value === PAGE_PASSWORD) {
                document.getElementById('login-section').classList.add('hidden');
                document.getElementById('main-content').classList.remove('hidden');
                init();
            } else { document.getElementById('login-error').classList.remove('hidden'); }
        }

        function init() {
            document.getElementById('sheet-url').value = config.sheet;
            document.getElementById('finnhub-key').value = config.finnhub;
            renderAssets();
            if (config.sheet) fetchAllData();
        }

        function saveConfig() {
            config.sheet = document.getElementById('sheet-url').value;
            config.finnhub = document.getElementById('finnhub-key').value;
            localStorage.setItem('global_config', JSON.stringify(config));
            fetchAllData();
        }

        // 2. æ ¸å¿ƒï¼šæ–°å¢èˆ‡è‡ªå‹•ç´¯åŠ 
        async function addAsset() {
            const name = document.getElementById('asset-name').value.toUpperCase().trim();
            const amount = parseFloat(document.getElementById('asset-amount').value);
            const type = document.getElementById('asset-type').value;
            if (!name || isNaN(amount)) return;

            const existing = assets.find(a => a.name === name && a.type === type);
            if (existing) {
                existing.amount += amount; // è‡ªå‹•ç´¯åŠ 
            } else {
                assets.push({ name, amount, type, price: 0 });
            }
            saveAndRefresh();
        }

        // 3. ç·¨è¼¯åŠŸèƒ½
        function editAsset(index) {
            const newAmount = prompt("è«‹è¼¸å…¥æ–°çš„è‚¡æ•¸:", assets[index].amount);
            if (newAmount !== null && !isNaN(parseFloat(newAmount))) {
                assets[index].amount = parseFloat(newAmount);
                saveAndRefresh();
            }
        }

        // 4. åˆªé™¤åŠŸèƒ½
        function deleteAsset(index) {
            if (confirm(`ç¢ºå®šè¦åˆªé™¤ ${assets[index].name} å—ï¼Ÿ`)) {
                assets.splice(index, 1);
                saveAndRefresh();
            }
        }

        function saveAndRefresh() {
            localStorage.setItem('global_assets', JSON.stringify(assets));
            renderAssets();
            fetchAllData();
            document.getElementById('asset-name').value = "";
            document.getElementById('asset-amount').value = "";
        }

        // 5. æŠ“å–æ•¸æ“š (API & Google Sheet)
        async function fetchAllData() {
            if (!config.sheet) return;
            try {
                const res = await fetch(config.sheet);
                const csv = await res.text();
                const rows = csv.split('\n').map(r => r.split(','));
                
                // æ›´æ–°åŒ¯ç‡ (CSV éœ€æœ‰ USDTWD é€™ä¸€åˆ—)
                const fxRow = rows.find(r => r[0].trim() === 'USDTWD');
                if (fxRow) {
                    fxRate = parseFloat(fxRow[1]);
                    document.getElementById('fx-rate-display').innerText = `ç›®å‰åŒ¯ç‡ 1 USD = ${fxRate.toFixed(2)} TWD`;
                }

                for (let asset of assets) {
                    if (asset.type === 'TWD') {
                        const found = rows.find(r => r[0].trim() === asset.name);
                        asset.price = found ? parseFloat(found[1]) : 0;
                    } else if (asset.type === 'USD' && config.finnhub) {
                        const fhRes = await fetch(`https://finnhub.io/api/v1/quote?symbol=${asset.name}&token=${config.finnhub}`);
                        const fhData = await fhRes.json();
                        asset.price = fhData.c || 0;
                    }
                }
                renderAssets();
            } catch (e) { console.error("æ›´æ–°å¤±æ•—", e); }
        }

        // 6. æ¸²æŸ“ç•«é¢
        function renderAssets() {
            const list = document.getElementById('asset-list');
            const currency = document.getElementById('display-currency').value;
            list.innerHTML = '';
            let total = 0;

            assets.forEach((asset, i) => {
                const price = asset.price || 0;
                let valTWD = asset.type === 'TWD' ? (price * asset.amount) : (price * asset.amount * fxRate);
                let displayVal = currency === 'TWD' ? valTWD : valTWD / fxRate;
                total += displayVal;

                list.innerHTML += `
                    <tr class="hover:bg-slate-50 transition">
                        <td class="p-4 font-bold">${asset.name} <span class="text-[10px] bg-slate-200 px-1 rounded">${asset.type}</span></td>
                        <td class="p-4 font-mono">${asset.amount.toLocaleString()}</td>
                        <td class="p-4 font-mono text-blue-600">${price.toFixed(2)}</td>
                        <td class="p-4 text-right font-black">$${displayVal.toLocaleString(undefined,{maximumFractionDigits:0})}</td>
                        <td class="p-4 text-center space-x-2">
                            <button onclick="editAsset(${i})" class="text-indigo-500 hover:underline">ç·¨è¼¯</button>
                            <button onclick="deleteAsset(${i})" class="text-red-400 hover:underline">åˆªé™¤</button>
                        </td>
                    </tr>`;
            });
            document.getElementById('total-val').innerText = `${currency} ${total.toLocaleString(undefined,{maximumFractionDigits:0})}`;
        }
    </script>
</body>
</html>


