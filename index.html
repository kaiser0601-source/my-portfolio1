<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¾è‚¡è³‡ç”¢é…ç½®ç›£æ§</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-50 min-h-screen font-sans text-slate-900">

    <div id="login-section" class="fixed inset-0 bg-slate-900 flex items-center justify-center z-50">
        <div class="bg-white p-10 rounded-2xl shadow-2xl w-full max-w-md">
            <h2 class="text-3xl font-black text-center mb-6">ç§äººç¾è‚¡åº«</h2>
            <input type="password" id="password-input" placeholder="è«‹è¼¸å…¥è¨ªå•å¯†ç¢¼" class="w-full p-3 border-2 rounded-xl mb-4 text-center text-lg">
            <button onclick="checkPassword()" class="w-full bg-blue-600 text-white py-3 rounded-xl font-bold hover:bg-blue-700 transition">è§£é–é€²å…¥</button>
            <p id="login-error" class="text-red-500 text-sm mt-4 text-center hidden">âŒ å¯†ç¢¼éŒ¯èª¤</p>
        </div>
    </div>

    <div id="main-content" class="hidden container mx-auto p-4 max-w-5xl">
        <header class="flex justify-between items-center my-8 bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
            <div>
                <h1 class="text-2xl font-black text-slate-800">US Stock Portfolio</h1>
                <div class="flex items-center gap-2 mt-1">
                    <span class="text-sm font-bold text-slate-400 uppercase tracking-wider">USD/TWD Rate:</span>
                    <input type="number" id="fx-rate-input" onchange="updateFxRate()" class="w-20 p-1 border rounded font-mono font-bold text-blue-600" step="0.1">
                </div>
            </div>
            <div class="flex gap-3">
                <select id="display-currency" onchange="renderAssets()" class="p-2 border rounded-lg font-bold bg-slate-50">
                    <option value="USD">é¡¯ç¤º USD</option>
                    <option value="TWD">é¡¯ç¤º TWD</option>
                </select>
                <button onclick="fetchAllPrices()" class="bg-indigo-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-indigo-700 transition">ğŸ”„ åˆ·æ–°è¡Œæƒ…</button>
            </div>
        </header>

        <div class="mb-6 px-4 py-2 bg-slate-100 rounded-lg inline-block text-xs font-mono text-slate-500">
            API Key: d5ut0d1r01...acis0 (å·²é€£æ¥)
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-8 bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
            <div>
                <label class="block text-xs font-bold text-slate-400 mb-1">ç¾è‚¡ä»£è™Ÿ (Symbol)</label>
                <input type="text" id="asset-name" placeholder="ä¾‹å¦‚: NVDA" class="w-full p-3 border rounded-xl uppercase font-bold focus:border-blue-500 outline-none">
            </div>
            <div>
                <label class="block text-xs font-bold text-slate-400 mb-1">æŒæœ‰è‚¡æ•¸ (Shares)</label>
                <input type="number" id="asset-amount" placeholder="0.00" class="w-full p-3 border rounded-xl font-mono focus:border-blue-500 outline-none">
            </div>
            <div class="flex items-end">
                <button onclick="addAsset()" class="w-full bg-blue-600 text-white p-3 rounded-xl font-bold hover:bg-blue-700 shadow-lg transition">+ æ–°å¢ / è‡ªå‹•ç´¯åŠ </button>
            </div>
        </div>

        <div class="bg-white rounded-2xl shadow-xl border border-slate-200 overflow-hidden mb-6">
            <div class="overflow-x-auto">
                <table class="w-full text-left border-collapse">
                    <thead class="bg-slate-50 border-b border-slate-100">
                        <tr>
                            <th class="p-4 text-sm font-bold text-slate-500">æ¨™çš„ä»£è™Ÿ</th>
                            <th class="p-4 text-sm font-bold text-slate-500 text-right">æŒæœ‰è‚¡æ•¸</th>
                            <th class="p-4 text-sm font-bold text-slate-500 text-right">æœ€æ–°å¸‚åƒ¹</th>
                            <th class="p-4 text-sm font-bold text-slate-500 text-right">ç›®å‰ä¼°å€¼</th>
                            <th class="p-4 text-sm font-bold text-slate-500 text-center">ç®¡ç†</th>
                        </tr>
                    </thead>
                    <tbody id="asset-list" class="divide-y divide-slate-100"></tbody>
                </table>
            </div>
            <div class="p-8 bg-slate-900 text-white flex justify-between items-center">
                <span class="text-slate-400 font-bold uppercase tracking-widest">Portfolio Total Value</span>
                <span id="total-val" class="text-4xl font-black text-yellow-400 font-mono">$ 0.00</span>
            </div>
        </div>
    </div>

    <script>
        // --- è¨­å®šå€ ---
        const PAGE_PASSWORD = "9003042449"; // ä¿®æ”¹ä½ çš„ç¶²é é–‹å•Ÿå¯†ç¢¼
        const API_KEY = "d5ut0d1r01qr4f8acirgd5ut0d1r01qr4f8acis0"; // å·²ç‚ºæ‚¨å¡«å…¥
        
        let assets = JSON.parse(localStorage.getItem('us_only_assets')) || [];
        let fxRate = parseFloat(localStorage.getItem('us_twd_rate')) || 32.2;

        // 1. ç™»å…¥é‚è¼¯
        function checkPassword() {
            const input = document.getElementById('password-input').value;
            if (input === PAGE_PASSWORD) {
                document.getElementById('login-section').classList.add('hidden');
                document.getElementById('main-content').classList.remove('hidden');
                init();
            } else {
                document.getElementById('login-error').classList.remove('hidden');
            }
        }

        // 2. åˆå§‹åŒ–
        function init() {
            document.getElementById('fx-rate-input').value = fxRate;
            renderAssets();
            if (assets.length > 0) fetchAllPrices();
        }

        function updateFxRate() {
            fxRate = parseFloat(document.getElementById('fx-rate-input').value) || 32.0;
            localStorage.setItem('us_twd_rate', fxRate);
            renderAssets();
        }

        // 3. æ ¸å¿ƒåŠŸèƒ½ï¼šæ–°å¢èˆ‡è‡ªå‹•ç´¯åŠ 
        async function addAsset() {
            const name = document.getElementById('asset-name').value.toUpperCase().trim();
            const amount = parseFloat(document.getElementById('asset-amount').value);
            if (!name || isNaN(amount)) return;

            const existing = assets.find(a => a.name === name);
            if (existing) {
                existing.amount += amount; // ç›¸åŒä»£è™Ÿå‰‡ç´¯åŠ è‚¡æ•¸
            } else {
                assets.push({ name, amount, price: 0 });
            }

            saveAndRefresh();
        }

        // 4. ç®¡ç†åŠŸèƒ½ï¼šç·¨è¼¯èˆ‡åˆªé™¤
        function editAsset(index) {
            const newAmount = prompt(`ä¿®æ”¹ ${assets[index].name} çš„æŒæœ‰è‚¡æ•¸:`, assets[index].amount);
            if (newAmount !== null && !isNaN(parseFloat(newAmount))) {
                assets[index].amount = parseFloat(newAmount);
                saveAndRefresh();
            }
        }

        function deleteAsset(index) {
            if (confirm(`ç¢ºå®šè¦åˆªé™¤ ${assets[index].name} å—ï¼Ÿ`)) {
                assets.splice(index, 1);
                saveAndRefresh();
            }
        }

        function saveAndRefresh() {
            localStorage.setItem('us_only_assets', JSON.stringify(assets));
            document.getElementById('asset-name').value = "";
            document.getElementById('asset-amount').value = "";
            renderAssets();
            fetchAllPrices();
        }

        // 5. æŠ“å–ç¾è‚¡å ±åƒ¹ (Finnhub)
        async function fetchAllPrices() {
            if (!API_KEY) return;
            for (let asset of assets) {
                try {
                    const res = await fetch(`https://finnhub.io/api/v1/quote?symbol=${asset.name}&token=${API_KEY}`);
                    const data = await res.json();
                    if (data.c) asset.price = data.c;
                } catch (e) { console.error("æŠ“å–å¤±æ•—", asset.name); }
            }
            renderAssets();
        }

        // 6. æ¸²æŸ“ç•«é¢èˆ‡å¹£åˆ¥è½‰æ›
        function renderAssets() {
            const list = document.getElementById('asset-list');
            const currency = document.getElementById('display-currency').value;
            list.innerHTML = '';
            let totalUSD = 0;

            assets.forEach((asset, i) => {
                const subtotalUSD = asset.amount * (asset.price || 0);
                totalUSD += subtotalUSD;
                
                const displayPrice = currency === 'TWD' ? (asset.price * fxRate) : asset.price;
                const displaySubtotal = currency === 'TWD' ? (subtotalUSD * fxRate) : subtotalUSD;

                list.innerHTML += `
                    <tr class="hover:bg-slate-50 transition">
                        <td class="p-4 font-black text-slate-700">${asset.name}</td>
                        <td class="p-4 text-right font-mono font-bold">${asset.amount.toLocaleString()}</td>
                        <td class="p-4 text-right font-mono text-blue-600 font-bold">${displayPrice.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                        <td class="p-4 text-right font-mono font-black">$${displaySubtotal.toLocaleString(undefined, {minimumFractionDigits: 0, maximumFractionDigits: 0})}</td>
                        <td class="p-4 text-center space-x-2">
                            <button onclick="editAsset(${i})" class="text-indigo-500 font-bold hover:underline">ç·¨è¼¯</button>
                            <button onclick="deleteAsset(${i})" class="text-red-400 font-bold hover:underline">åˆªé™¤</button>
                        </td>
                    </tr>
                `;
            });

            const finalTotal = currency === 'TWD' ? (totalUSD * fxRate) : totalUSD;
            document.getElementById('total-val').innerText = `${currency} ${finalTotal.toLocaleString(undefined, {minimumFractionDigits: 0, maximumFractionDigits: 0})}`;
        }
    </script>
</body>
</html>
