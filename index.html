<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¾è‚¡è³‡ç”¢ç®¡ç†ç³»çµ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-50 min-h-screen font-sans text-slate-900">

    <div id="login-section" class="fixed inset-0 bg-slate-900 flex items-center justify-center z-50">
        <div class="bg-white p-10 rounded-2xl shadow-2xl w-full max-w-md">
            <h2 class="text-3xl font-black text-center mb-6 text-slate-800">Private Vault</h2>
            <input type="password" id="password-input" placeholder="è«‹è¼¸å…¥è¨ªå•å¯†ç¢¼" class="w-full p-4 border-2 rounded-xl mb-4 text-center text-lg focus:border-blue-500 outline-none">
            <button onclick="checkPassword()" class="w-full bg-blue-600 text-white py-3 rounded-xl font-bold hover:bg-blue-700 transition shadow-lg">è§£é–é€²å…¥</button>
            <p id="login-error" class="text-red-500 text-sm mt-4 text-center hidden">âŒ å¯†ç¢¼éŒ¯èª¤</p>
        </div>
    </div>

    <div id="main-content" class="hidden container mx-auto p-4 max-w-7xl">
        <header class="flex flex-col md:flex-row justify-between items-start md:items-center my-8 bg-white p-6 rounded-2xl shadow-sm border border-slate-200 gap-4">
            <div>
                <h1 class="text-2xl font-black text-slate-800 tracking-tight">Investment Portfolio</h1>
                <div class="flex items-center gap-2 mt-2">
                    <span class="text-xs font-bold text-slate-400 uppercase">åŒ¯ç‡ USD/TWD</span>
                    <input type="number" id="fx-rate-input" onchange="updateFxRate()" class="w-20 p-1 border rounded font-mono font-bold text-blue-600 shadow-inner" step="0.1">
                </div>
            </div>
            <div class="flex gap-3 w-full md:w-auto">
                <select id="display-currency" onchange="renderAssets()" class="p-2 border rounded-lg font-bold bg-slate-50 shadow-sm">
                    <option value="USD">é¡¯ç¤º USD</option>
                    <option value="TWD">é¡¯ç¤º TWD</option>
                </select>
                <button onclick="fetchAllPrices()" class="bg-indigo-600 text-white px-6 py-2 rounded-lg font-bold hover:bg-indigo-700 transition shadow-md">ğŸ”„ åˆ·æ–°å ±åƒ¹</button>
            </div>
        </header>

        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8 bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
            <div>
                <label class="block text-xs font-bold text-slate-400 mb-1">ç¾è‚¡ä»£è™Ÿ</label>
                <input type="text" id="asset-name" placeholder="NVDA" class="w-full p-3 border rounded-xl uppercase font-bold focus:ring-2 focus:ring-blue-500 outline-none">
            </div>
            <div>
                <label class="block text-xs font-bold text-slate-400 mb-1">æŒæœ‰è‚¡æ•¸</label>
                <input type="number" id="asset-amount" placeholder="0.00" class="w-full p-3 border rounded-xl font-mono focus:ring-2 focus:ring-blue-500 outline-none">
            </div>
            <div>
                <label class="block text-xs font-bold text-slate-400 mb-1">å¹³å‡æˆæœ¬ (USD)</label>
                <input type="number" id="asset-cost" placeholder="0.00" class="w-full p-3 border rounded-xl font-mono focus:ring-2 focus:ring-blue-500 outline-none">
            </div>
            <div class="flex items-end">
                <button onclick="addAsset()" class="w-full bg-slate-800 text-white p-3 rounded-xl font-bold hover:bg-slate-700 shadow-lg transition">+ åŠ å…¥/ç´¯åŠ è³‡ç”¢</button>
            </div>
        </div>

        <div class="bg-white rounded-2xl shadow-xl border border-slate-200 overflow-hidden mb-6">
            <div class="overflow-x-auto">
                <table class="w-full text-left border-collapse">
                    <thead class="bg-slate-50 border-b border-slate-100">
                        <tr>
                            <th class="p-4 text-xs font-bold text-slate-400 uppercase">æ¨™çš„</th>
                            <th class="p-4 text-xs font-bold text-slate-400 uppercase text-right">æŒè‚¡/æˆæœ¬</th>
                            <th class="p-4 text-xs font-bold text-slate-400 uppercase text-right">ç¾åƒ¹</th>
                            <th class="p-4 text-xs font-bold text-slate-400 uppercase text-right">ä»Šæ—¥æç›Š</th>
                            <th class="p-4 text-xs font-bold text-slate-400 uppercase text-right">ç´¯è¨ˆæç›Š</th>
                            <th class="p-4 text-xs font-bold text-slate-400 uppercase text-right">ç›®å‰å¸‚å€¼</th>
                            <th class="p-4 text-xs font-bold text-slate-400 uppercase text-center">ç®¡ç†</th>
                        </tr>
                    </thead>
                    <tbody id="asset-list" class="divide-y divide-slate-100"></tbody>
                </table>
            </div>
            
            <div class="p-8 bg-slate-900 text-white">
                <div class="flex flex-col items-center md:items-end w-full">
                    <p class="text-slate-400 text-sm font-bold uppercase tracking-widest mb-1">Portfolio Total Value</p>
                    <div id="total-val" class="text-5xl font-black text-yellow-400 font-mono mb-2">$ 0.00</div>
                    <div class="flex gap-4">
                        <div id="total-daily-change" class="text-sm font-mono font-bold px-3 py-1 rounded-lg">ä»Šæ—¥: --</div>
                        <div id="total-all-change" class="text-sm font-mono font-bold px-3 py-1 rounded-lg">ç´¯è¨ˆ: --</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- è¨­å®šå€ ---
        const PAGE_PASSWORD = "9003042449"; 
        const API_KEY = "d5ut0d1r01qr4f8acirgd5ut0d1r01qr4f8acis0"; 
        
        let assets = JSON.parse(localStorage.getItem('us_portfolio_v3')) || [];
        let fxRate = parseFloat(localStorage.getItem('us_twd_rate')) || 32.2;

        function checkPassword() {
            if (document.getElementById('password-input').value === PAGE_PASSWORD) {
                document.getElementById('login-section').classList.add('hidden');
                document.getElementById('main-content').classList.remove('hidden');
                init();
            } else { document.getElementById('login-error').classList.remove('hidden'); }
        }

        function init() {
            document.getElementById('fx-rate-input').value = fxRate;
            renderAssets();
            if (assets.length > 0) fetchAllPrices();
        }

        function updateFxRate() {
            fxRate = parseFloat(document.getElementById('fx-rate-input').value) || 32.0;
            localStorage.setItem('us_twd_rate', fxRate);
            renderAssets();
        }

        async function addAsset() {
            const name = document.getElementById('asset-name').value.toUpperCase().trim();
            const amount = parseFloat(document.getElementById('asset-amount').value);
            const cost = parseFloat(document.getElementById('asset-cost').value);
            if (!name || isNaN(amount) || isNaN(cost)) return;

            const existing = assets.find(a => a.name === name);
            if (existing) {
                // è¨ˆç®—åŠ æ¬Šå¹³å‡æˆæœ¬
                const totalCost = (existing.amount * existing.cost) + (amount * cost);
                existing.amount += amount;
                existing.cost = totalCost / existing.amount;
            } else {
                assets.push({ name, amount, cost, price: 0, change: 0, changePercent: 0 });
            }

            saveAndRefresh();
        }

        function editAsset(index) {
            const newAmount = prompt(`ä¿®æ”¹ ${assets[index].name} è‚¡æ•¸:`, assets[index].amount);
            const newCost = prompt(`ä¿®æ”¹ ${assets[index].name} æˆæœ¬ (USD):`, assets[index].cost);
            if (newAmount !== null && newCost !== null) {
                assets[index].amount = parseFloat(newAmount);
                assets[index].cost = parseFloat(newCost);
                saveAndRefresh();
            }
        }

        function deleteAsset(index) {
            if (confirm(`ç¢ºå®šåˆªé™¤ ${assets[index].name}ï¼Ÿ`)) {
                assets.splice(index, 1);
                saveAndRefresh();
            }
        }

        function saveAndRefresh() {
            localStorage.setItem('us_portfolio_v3', JSON.stringify(assets));
            document.getElementById('asset-name').value = "";
            document.getElementById('asset-amount').value = "";
            document.getElementById('asset-cost').value = "";
            renderAssets();
            fetchAllPrices();
        }

        async function fetchAllPrices() {
            if (!API_KEY) return;
            for (let asset of assets) {
                try {
                    const res = await fetch(`https://finnhub.io/api/v1/quote?symbol=${asset.name}&token=${API_KEY}`);
                    const data = await res.json();
                    if (data.c) {
                        asset.price = data.c;       
                        asset.change = data.d;      
                        asset.changePercent = data.dp; 
                    }
                } catch (e) { console.error("æŠ“å–å¤±æ•—", asset.name); }
            }
            renderAssets();
        }

        function renderAssets() {
            const list = document.getElementById('asset-list');
            const currency = document.getElementById('display-currency').value;
            list.innerHTML = '';
            
            let totalUSD = 0;
            let totalDailyChangeUSD = 0;
            let totalCostUSD = 0;

            assets.forEach(a => {
                totalUSD += (a.amount * (a.price || 0));
                totalCostUSD += (a.amount * a.cost);
            });

            assets.forEach((asset, i) => {
                const subtotalUSD = asset.amount * (asset.price || 0);
                const dailyProfitUSD = asset.amount * (asset.change || 0);
                const totalProfitUSD = subtotalUSD - (asset.amount * asset.cost);
                totalDailyChangeUSD += dailyProfitUSD;
                
                const ratio = totalUSD > 0 ? (subtotalUSD / totalUSD * 100).toFixed(1) : 0;
                
                const displayPrice = currency === 'TWD' ? (asset.price * fxRate) : asset.price;
                const displayCost = currency === 'TWD' ? (asset.cost * fxRate) : asset.cost;
                const displaySubtotal = currency === 'TWD' ? (subtotalUSD * fxRate) : subtotalUSD;
                const displayDailyProfit = currency === 'TWD' ? (dailyProfitUSD * fxRate) : dailyProfitUSD;
                const displayTotalProfit = currency === 'TWD' ? (totalProfitUSD * fxRate) : totalProfitUSD;

                const dailyColor = asset.change >= 0 ? 'text-green-500' : 'text-red-500';
                const totalColor = totalProfitUSD >= 0 ? 'text-green-500' : 'text-red-500';

                list.innerHTML += `
                    <tr class="hover:bg-slate-50 transition border-b border-slate-50">
                        <td class="p-4">
                            <div class="font-black text-slate-700 text-lg">${asset.name}</div>
                            <div class="text-[10px] font-bold text-slate-400 uppercase">ä½”æ¯” ${ratio}%</div>
                        </td>
                        <td class="p-4 text-right">
                            <div class="font-mono font-bold">${asset.amount.toLocaleString()}</div>
                            <div class="text-xs text-slate-400 font-mono">æˆæœ¬: ${displayCost.toLocaleString(undefined, {maximumFractionDigits: 1})}</div>
                        </td>
                        <td class="p-4 text-right font-mono font-bold text-slate-600">${displayPrice.toLocaleString(undefined, {minimumFractionDigits: 2})}</td>
                        <td class="p-4 text-right font-mono font-bold ${dailyColor}">
                            ${displayDailyProfit >= 0 ? '+' : ''}${displayDailyProfit.toLocaleString(undefined, {maximumFractionDigits: 0})}<br>
                            <span class="text-[10px]">(${asset.changePercent.toFixed(2)}%)</span>
                        </td>
                        <td class="p-4 text-right font-mono font-bold ${totalColor}">
                            ${displayTotalProfit >= 0 ? '+' : ''}${displayTotalProfit.toLocaleString(undefined, {maximumFractionDigits: 0})}<br>
                            <span class="text-[10px]">(${(totalProfitUSD / (asset.amount * asset.cost) * 100).toFixed(2)}%)</span>
                        </td>
                        <td class="p-4 text-right font-mono font-black text-lg">$${displaySubtotal.toLocaleString(undefined, {maximumFractionDigits: 0})}</td>
                        <td class="p-4 text-center space-x-1">
                            <button onclick="editAsset(${i})" class="p-2 text-slate-300 hover:text-indigo-600">âœ</button>
                            <button onclick="deleteAsset(${i})" class="p-2 text-slate-300 hover:text-red-500">âœ•</button>
                        </td>
                    </tr>
                `;
            });

            // æ›´æ–°ç¸½è¨ˆ
            const finalTotal = currency === 'TWD' ? (totalUSD * fxRate) : totalUSD;
            const finalDaily = currency === 'TWD' ? (totalDailyChangeUSD * fxRate) : totalDailyChangeUSD;
            const finalAll = currency === 'TWD' ? ((totalUSD - totalCostUSD) * fxRate) : (totalUSD - totalCostUSD);
            const totalAllPercent = totalCostUSD > 0 ? ((totalUSD - totalCostUSD) / totalCostUSD * 100).toFixed(2) : 0;

            document.getElementById('total-val').innerText = `${currency} ${finalTotal.toLocaleString(undefined, {maximumFractionDigits: 0})}`;
            
            const dailyEl = document.getElementById('total-daily-change');
            dailyEl.className = `text-sm font-mono font-bold px-3 py-1 rounded-lg ${totalDailyChangeUSD >= 0 ? 'bg-green-500/10 text-green-400' : 'bg-red-500/10 text-red-400'}`;
            dailyEl.innerText = `ä»Šæ—¥: ${finalDaily >= 0 ? '+' : ''}${finalDaily.toLocaleString(undefined, {maximumFractionDigits: 0})}`;

            const allEl = document.getElementById('total-all-change');
            allEl.className = `text-sm font-mono font-bold px-3 py-1 rounded-lg ${finalAll >= 0 ? 'bg-green-500/10 text-green-400' : 'bg-red-500/10 text-red-400'}`;
            allEl.innerText = `ç´¯è¨ˆ: ${finalAll >= 0 ? '+' : ''}${finalAll.toLocaleString(undefined, {maximumFractionDigits: 0})} (${totalAllPercent}%)`;
        }
    </script>
</body>
</html>
